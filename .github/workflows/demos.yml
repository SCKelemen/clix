name: Generate Demo GIFs

on:
  push:
    branches:
      - main
    paths:
      - 'examples/**'
      - 'demos/vhs/generate-demos.sh'
      - '.github/workflows/demos.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'examples/**'
      - 'demos/vhs/generate-demos.sh'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all GIFs'
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tapes: ${{ steps.tapes.outputs.tapes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Find all tape files
        id: tapes
        run: |
          # Find all tape files and output as JSON array for matrix
          TAPES=$(find examples -name "*.tape" -type f | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "tapes=$TAPES" >> $GITHUB_OUTPUT
          echo "Found tape files:"
          find examples -name "*.tape" -type f

  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: go.sum
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd xvfb
      
      - name: Cache VHS binary
        id: cache-vhs
        uses: actions/cache@v4
        with:
          path: ${{ env.GOPATH }}/bin
          key: vhs-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            vhs-${{ runner.os }}-
      
      - name: Install VHS
        if: steps.cache-vhs.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/go/bin
          go install github.com/charmbracelet/vhs@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

  generate-demos:
    needs: [prepare, setup]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tape: ${{ fromJson(needs.prepare.outputs.tapes) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Restore VHS from cache
        id: cache-vhs
        uses: actions/cache@v4
        with:
          path: ${{ env.GOPATH }}/bin
          key: vhs-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            vhs-${{ runner.os }}-
      
      - name: Install VHS if not cached
        if: steps.cache-vhs.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/go/bin
          go install github.com/charmbracelet/vhs@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd xvfb
      
      - name: Build example
        run: |
          TAPE_FILE="${{ matrix.tape }}"
          EXAMPLE_DIR=$(dirname "$TAPE_FILE")
          EXAMPLE_NAME=$(basename "$EXAMPLE_DIR")
          
          # Build the example
          if [ -d "$EXAMPLE_DIR/cmd" ]; then
            for cmd_dir in "$EXAMPLE_DIR/cmd"/*/; do
              if [ -f "$cmd_dir/main.go" ]; then
                cmd_name=$(basename "$cmd_dir")
                binary_name="$EXAMPLE_NAME"
                
                # Special cases
                case "$EXAMPLE_NAME" in
                  "basic") binary_name="demo" ;;
                  "survey") binary_name="demo" ;;
                  "lipgloss") binary_name="styled" ;;
                esac
                
                echo "Building $cmd_name -> $binary_name"
                (cd "$EXAMPLE_DIR" && go build -o "$binary_name" "./cmd/$cmd_name" || true)
              fi
            done
          fi
          
          # Handle multicli separately
          if [ "$EXAMPLE_NAME" = "multicli" ] && [ -d "$EXAMPLE_DIR/cmd" ]; then
            cd "$EXAMPLE_DIR"
            for cmd_dir in cmd/*/; do
              if [ -f "$cmd_dir/main.go" ]; then
                binary=$(basename "$cmd_dir")
                echo "Building multicli/$binary"
                go build -o "$binary" "./$cmd_dir" || true
              fi
            done
          fi
      
      - name: Discover and generate tape file
        run: |
          cd demos/vhs
          chmod +x generate-demos.sh
          GENERATE_GIFS=0 ./generate-demos.sh
      
      - name: Setup display server
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 2
      
      - name: Generate demo GIF
        run: |
          export DISPLAY=:99
          export PATH="/usr/bin:/bin:/usr/local/bin:$HOME/go/bin:$PATH"
          TAPE_FILE="${{ matrix.tape }}"
          # Use bash parameter expansion instead of dirname/basename
          EXAMPLE_DIR="${TAPE_FILE%/*}"
          TAPE_NAME="${TAPE_FILE##*/}"
          
          # Ensure we're in the example directory
          cd "$EXAMPLE_DIR"
          echo "Working directory: $(pwd)"
          echo "Go version: $(go version)"
          echo "Contents before VHS:"
          ls -la
          
          echo "Generating GIF from $TAPE_FILE"
          # VHS needs Go in PATH for the build commands in tape files
          vhs < "$TAPE_NAME" || {
            echo "VHS failed, checking for errors..."
            echo "Contents after VHS:"
            ls -la
            exit 1
          }
          
          # Upload generated GIF as artifact
          GIF_FILE="${TAPE_NAME%.tape}.gif"
          if [ -f "$GIF_FILE" ]; then
            echo "GIF generated: $GIF_FILE"
            mkdir -p "$GITHUB_WORKSPACE/gifs"
            cp "$GIF_FILE" "$GITHUB_WORKSPACE/gifs/"
          fi
        env:
          DISPLAY: :99
          PATH: /usr/bin:/bin:/usr/local/bin:${{ env.PATH }}:$HOME/go/bin
      
      - name: Upload generated GIF
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gif-${{ matrix.tape }}
          path: gifs/*.gif
          retention-days: 1

  commit:
    needs: generate-demos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Download all generated GIFs
        uses: actions/download-artifact@v4
        with:
          pattern: gif-*
          merge-multiple: true
          path: gifs
      
      - name: Copy GIFs to example directories
        run: |
          # Copy each downloaded GIF to its corresponding example directory
          for gif_file in gifs/*.gif; do
            if [ -f "$gif_file" ]; then
              gif_name=$(basename "$gif_file")
              echo "Processing $gif_name"
              
              # Find matching example directory by checking tape files
              for example_dir in examples/*/; do
                for tape_file in "$example_dir"/*.tape; do
                  if [ -f "$tape_file" ]; then
                    expected_gif="${tape_file%.tape}.gif"
                    if [ "$(basename "$expected_gif")" = "$gif_name" ]; then
                      echo "Copying $gif_name to $example_dir"
                      cp "$gif_file" "$example_dir/"
                      break 2
                    fi
                  fi
                done
              done
            fi
          done
      
      - name: Check for changes
        id: check
        run: |
          if [ -n "$(git status --porcelain examples/*/*.gif examples/*/*.tape)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git status --porcelain examples/*/*.gif examples/*/*.tape
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.check.outputs.changed == 'true'
        run: |
          # Get the branch name - use HEAD_REF for PRs, otherwise extract from GITHUB_REF
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
          fi
          # Checkout the branch if we're in detached HEAD state
          git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          git config --local user.email "${{ secrets.GIT_USER_EMAIL || 'SCKelemen@users.noreply.github.com' }}"
          git config --local user.name "${{ secrets.GIT_USER_NAME || 'Samuel Kelemen' }}"
          git add examples/*/*.gif examples/*/*.tape
          git commit -m "Auto-update demo GIFs [skip ci]" || exit 0
          git push origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
